@page "/purchases"
@attribute [Authorize]

@using PeopleApp.Client.Dtos.Purchases
@inject PurchasesApiClient PurchasesApi
@inject NavigationManager Nav
@inject DialogService DialogService

<RadzenCard>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Compras</h3>
        <RadzenButton Text="Nueva compra" Icon="add_circle" ButtonStyle="ButtonStyle.Primary"
            Click="OpenNewPurchaseDialog" />
    </div>

    <RadzenCard Style="margin-bottom:12px;">
        <div
            style="display:grid; grid-template-columns: 1.4fr 220px 220px 180px 180px auto; gap:12px; align-items:end;">
            <div>
                <RadzenLabel Text="Buscar" />
                <RadzenTextBox Style="width:100%" @bind-Value="_filters.Search" Placeholder="Cliente o Id..." />
            </div>

            <div>
                <RadzenLabel Text="Desde" />
                <RadzenDatePicker Style="width:100%" @bind-Value="_filters.From" DateFormat="yyyy-MM-dd" />
            </div>

            <div>
                <RadzenLabel Text="Hasta" />
                <RadzenDatePicker Style="width:100%" @bind-Value="_filters.To" DateFormat="yyyy-MM-dd" />
            </div>

            <div>
                <RadzenLabel Text="Total mín." />
                <RadzenNumeric Style="width:100%" @bind-Value="_filters.MinTotal" Min="0" />
            </div>

            <div>
                <RadzenLabel Text="Total máx." />
                <RadzenNumeric Style="width:100%" @bind-Value="_filters.MaxTotal" Min="0" />
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <RadzenButton Text="Aplicar" Icon="search" ButtonStyle="ButtonStyle.Primary" Click="@ApplyFilters" />
                <RadzenButton Text="Limpiar" Icon="close" ButtonStyle="ButtonStyle.Light" Click="@ClearFilters" />
            </div>
        </div>
    </RadzenCard>


    <RadzenDataGrid Data="@_items" TItem="PurchaseListItemDto" AllowPaging="true" PageSize="10">
        <Columns>
            <RadzenDataGridColumn TItem="PurchaseListItemDto" Property="Id" Title="Id" />

            <RadzenDataGridColumn TItem="PurchaseListItemDto" Title="Fecha">
                <Template Context="p">@p.Date.ToString("yyyy-MM-dd")</Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="PurchaseListItemDto" Property="CustomerName" Title="Cliente" />

            <RadzenDataGridColumn TItem="PurchaseListItemDto" Title="Total">
                <Template Context="p">@p.Total</Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="PurchaseListItemDto" Title="Acciones" Width="160px"
                TextAlign="TextAlign.Center">
                <Template Context="p">
                    <div style="display:flex; gap:8px; justify-content:center; align-items:center;">
                        <!-- Ver (siempre) -->
                        <RadzenButton Icon="visibility" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light"
                            Click="@(() => Nav.NavigateTo($"/purchases/{p.Id}"))" />

                        @if (_isAdmin)
                        {
                            <!-- Editar (solo Admin) -->
                            <RadzenButton Icon="edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Warning"
                                Click="@(() => Nav.NavigateTo($"/purchases/{p.Id}"))" />

                            <!-- Eliminar (solo Admin) -->
                            <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                Click="@(() => DeletePlaceholder(p.Id))" />
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>


        </Columns>
    </RadzenDataGrid>


    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <RadzenAlert Severity="AlertSeverity.Error" Summary="Error" Detail="@_error" />
    }
</RadzenCard>

@code {
    private List<PurchaseListItemDto> _items = new();
    private string? _error;
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private bool _isAdmin;


    protected override async Task OnInitializedAsync()
    {
        var state = await AuthenticationStateTask;
        _isAdmin = state.User.IsInRole("Admin");

        await Load();
    }


    private async Task Load()
    {
        _error = null;
        try
        {
            _items = await PurchasesApi.GetAllAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task OpenNewPurchaseDialog()
    {
        var result = await DialogService.OpenAsync<PurchaseNewDialog>(
        "Nueva compra",
        null,
        new DialogOptions { Width = "900px", Height = "650px", Resizable = true, Draggable = true }
        );

        // El dialog va a regresar el Id creado (int?) o null si canceló
        if (result is int newId)
        {
            await Load(); // refresca listado
            Nav.NavigateTo($"/purchases/{newId}"); // o solo dejarlo en lista, tú decides
        }
    }

    private PurchaseFilters _filters = new();

    private class PurchaseFilters
    {
        public string? Search { get; set; }
        public DateTime? From { get; set; }
        public DateTime? To { get; set; }
        public decimal? MinTotal { get; set; }
        public decimal? MaxTotal { get; set; }
    }

    private async Task ApplyFilters()
    {
        _error = null;

        // Validación de rango de fechas (UX pro)
        if (_filters.From is not null && _filters.To is not null && _filters.From > _filters.To)
        {
            _error = "La fecha 'Desde' no puede ser mayor que 'Hasta'.";
            return;
        }

        try
        {
            _items = await PurchasesApi.GetAllAsync(
            _filters.Search,
            _filters.From,
            _filters.To,
            _filters.MinTotal,
            _filters.MaxTotal);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task ClearFilters()
    {
        _filters = new();
        await Load(); // vuelve a cargar sin filtros
    }

    private void DeletePlaceholder(int id)
    {
        // TODO: aquí después conectamos DELETE real con confirmación
        Console.WriteLine($"Eliminar compra {id} (solo UI por ahora)");
    }


}