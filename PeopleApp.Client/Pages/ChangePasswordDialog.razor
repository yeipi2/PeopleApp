@using PeopleApp.Client.Dtos
@using Radzen
@using Radzen.Blazor
@inject PeopleApp.Client.Services.Auth.AuthService AuthService
@inject DialogService DialogService

<RadzenStack Gap="1.5rem">
    @if (!codeSent)
    {
        <!-- Paso 1: Confirmar contraseña actual -->
        <RadzenTemplateForm TItem="RequestPasswordChangeDto" Data="@requestModel" Submit="@HandleRequestCode">
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body1" Style="color: #666;">
                    Por seguridad, primero verifica tu contraseña actual.
                </RadzenText>

                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                    <RadzenLabel Component="CurrentPasswordInput" Style="font-weight: 500;">
                        Contraseña Actual
                    </RadzenLabel>
                    <RadzenPassword Name="CurrentPasswordInput" @bind-Value="requestModel.CurrentPassword"
                                    Placeholder="••••••••"
                                    Style="width:100%; height: 48px;" />
                    <RadzenRequiredValidator Component="CurrentPasswordInput" Text="Contraseña es requerida" />
                </RadzenStack>

                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage" />
                }

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Cancelar" Click="@(() => DialogService.Close(false))"
                                  ButtonStyle="ButtonStyle.Light" />
                    <RadzenButton Text="Continuar" ButtonType="ButtonType.Submit"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Disabled="@isBusy" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
    else
    {
        <!-- Paso 2: Ingresar código y nueva contraseña -->
        <RadzenTemplateForm TItem="VerifyPasswordChangeDto" Data="@verifyModel" Submit="@HandleVerifyAndChange">
            <RadzenStack Gap="1rem">
                <RadzenAlert Severity="AlertSeverity.Success" Variant="Variant.Flat">
                    <RadzenIcon Icon="mail" Style="margin-right: 8px;" />
                    Hemos enviado un código de verificación a tu correo.
                </RadzenAlert>

                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                    <RadzenLabel Component="CodeInput" Style="font-weight: 500;">
                        Código de Verificación
                    </RadzenLabel>
                    <RadzenTextBox Name="CodeInput" @bind-Value="verifyModel.Code"
                                   Placeholder="A1B2C3"
                                   Style="width:100%; height: 48px; text-align: center; font-size: 20px; letter-spacing: 4px; text-transform: uppercase;"
                                   MaxLength="6" />
                    <RadzenRequiredValidator Component="CodeInput" Text="Código es requerido" />
                    <RadzenLengthValidator Component="CodeInput" Min="6" Text="El código debe tener 6 caracteres" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                    <RadzenLabel Component="NewPasswordInput" Style="font-weight: 500;">
                        Nueva Contraseña
                    </RadzenLabel>
                    <RadzenPassword Name="NewPasswordInput" @bind-Value="verifyModel.NewPassword"
                                    Placeholder="••••••••"
                                    Style="width:100%; height: 48px;" />
                    <RadzenRequiredValidator Component="NewPasswordInput" Text="Nueva contraseña es requerida" />
                    <RadzenLengthValidator Component="NewPasswordInput" Min="8" Text="Mínimo 8 caracteres" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                    <RadzenLabel Component="ConfirmPasswordInput" Style="font-weight: 500;">
                        Confirmar Nueva Contraseña
                    </RadzenLabel>
                    <RadzenPassword Name="ConfirmPasswordInput" @bind-Value="verifyModel.ConfirmPassword"
                                    Placeholder="••••••••"
                                    Style="width:100%; height: 48px;" />
                    <RadzenRequiredValidator Component="ConfirmPasswordInput" Text="Confirmación es requerida" />
                    <RadzenCompareValidator Component="ConfirmPasswordInput" Value="@verifyModel.NewPassword"
                                            Operator="CompareOperator.Equal" Text="Las contraseñas no coinciden" />
                </RadzenStack>

                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage" />
                }

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Cancelar" Click="@(() => DialogService.Close(false))"
                                  ButtonStyle="ButtonStyle.Light" />
                    <RadzenButton Text="Cambiar Contraseña" ButtonType="ButtonType.Submit"
                                  ButtonStyle="ButtonStyle.Success"
                                  Disabled="@isBusy" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenStack>

@code {
    private RequestPasswordChangeDto requestModel = new();
    private VerifyPasswordChangeDto verifyModel = new();
    private string errorMessage = "";
    private bool isBusy = false;
    private bool codeSent = false;

    private async Task HandleRequestCode(RequestPasswordChangeDto model)
    {
        try
        {
            isBusy = true;
            errorMessage = "";

            await AuthService.RequestPasswordChangeAsync(model);
            codeSent = true;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task HandleVerifyAndChange(VerifyPasswordChangeDto model)
    {
        try
        {
            isBusy = true;
            errorMessage = "";

            await AuthService.VerifyPasswordChangeAsync(model);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }
}