@page "/register"
@layout PeopleApp.Client.Layout.AuthLayout

@using Radzen
@using Radzen.Blazor
@using PeopleApp.Client.Dtos
@inject PeopleApp.Client.Services.Auth.AuthService AuthService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider


<div style="text-align: center; margin-bottom: 1.5rem;">
    <div style="display: inline-block; padding: 16px; background-color: white; border-radius: 12px; border: 3px solid #ff6b35; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);">
        <RadzenIcon Icon="person_add" Style="font-size:48px; color:#ff6b35;" />
    </div>
</div>

<h3 class="auth-title" style="color: #333; font-weight: 700; margin-bottom: 0.5rem;">Crear nueva cuenta</h3>
<p style="text-align: center; color: #666; margin-bottom: 2rem; font-size: 14px;">Completa tus datos para comenzar</p>

<RadzenTemplateForm TItem="RegisterRequestDto" Data="@form" Submit="@HandleRegister">
    <RadzenStack Gap="1rem">

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="FirstNameInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="person" Style="color: #ff6b35;" class="rz-mr-1" />
                Nombre <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenTextBox Name="FirstNameInput" @bind-Value="form.FirstName" Placeholder="Ingresa tu nombre"
                           Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;" />
            <RadzenRequiredValidator Component="FirstNameInput" Text="Nombre es requerido" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="LastNameInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="badge" Style="color: #ff6b35;" class="rz-mr-1" />
                Apellido <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenTextBox Name="LastNameInput" @bind-Value="form.LastName" Placeholder="Ingresa tu apellido"
                           Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;" />
            <RadzenRequiredValidator Component="LastNameInput" Text="Apellido es requerido" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="PhoneInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="call" Style="color: #ff6b35;" class="rz-mr-1" />
                Teléfono <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenTextBox Name="PhoneInput" @bind-Value="form.PhoneNumber" Placeholder="10 dígitos"
                           Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;"
                           InputAttributes="@(new Dictionary<string, object>
                           {
                               ["inputmode"] = "numeric",
                               ["pattern"] = "[0-9]*",
                               ["maxlength"] = "10"
                           })" Change="@OnPhoneChanged" />
            <RadzenRequiredValidator Component="PhoneInput" Text="Teléfono es requerido" />
            <RadzenLengthValidator Component="PhoneInput" Min="10" Text="El teléfono debe tener mínimo 10 dígitos" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="EmailInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="mail" Style="color: #ff6b35;" class="rz-mr-1" />
                Email <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenTextBox Name="EmailInput" @bind-Value="form.Email" Placeholder="correo@ejemplo.com"
                           Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;" />
            <RadzenRequiredValidator Component="EmailInput" Text="Email es requerido" />
            <RadzenEmailValidator Component="EmailInput" Text="Ingresa un email válido" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="PasswordInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="lock" Style="color: #ff6b35;" class="rz-mr-1" />
                Contraseña <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenPassword Name="PasswordInput" @bind-Value="form.Password" Placeholder="Crea una contraseña segura"
                            Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;" />
            <RadzenRequiredValidator Component="PasswordInput" Text="Contraseña es requerida" />
            <RadzenCustomValidator Component="PasswordInput" Validator="@ValidatePassword" Text="@passwordRulesError" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="0.4rem">
            <RadzenLabel Component="ConfirmPasswordInput" Style="color: #555; font-size: 14px;">
                <RadzenIcon Icon="verified" Style="color: #ff6b35;" class="rz-mr-1" />
                Confirmar contraseña <span style="color: #ff6b35;">*</span>
            </RadzenLabel>
            <RadzenPassword Name="ConfirmPasswordInput" @bind-Value="form.ConfirmPassword"
                            Placeholder="Repite tu contraseña"
                            Style="width:100%; height: 46px; border-radius: 6px; border-left: 4px solid #ff6b35; background-color: white;" />
            <RadzenRequiredValidator Component="ConfirmPasswordInput" Text="Confirmación es requerida" />
            <RadzenCompareValidator Component="ConfirmPasswordInput" Value="@form.Password"
                                    Operator="CompareOperator.Equal" Text="Las contraseñas no coinciden" />
        </RadzenStack>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage"
                         Style="border-radius: 6px; border-left: 4px solid #d32f2f;" />
        }

        <RadzenButton Text="Crear cuenta" ButtonType="ButtonType.Submit"
                      Style="width:100%; height:50px; background-color:#ff6b35; border-radius: 6px; font-weight: 600; font-size: 15px; margin-top: 8px; border: none; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.25);"
                      ButtonStyle="ButtonStyle.Primary"
                      Disabled="@isBusy" />

        <div style="text-align:center; margin-top:10px; padding-top: 10px; border-top: 1px solid #ffd4b8;">
            <span style="color: #666;">¿Ya tienes cuenta?</span>
            <a href="/login" style="color: #ff6b35; font-weight: 600; text-decoration: none; margin-left: 4px;">Inicia sesión</a>
        </div>

    </RadzenStack>
</RadzenTemplateForm>

@code {
    private RegisterRequestDto form = new();
    private string errorMessage = "";
    private bool isBusy = false;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
            Nav.NavigateTo("/me", replace: true);
    }

    private async Task HandleRegister(RegisterRequestDto form)
    {
        try
        {
            isBusy = true;
            errorMessage = "";

            if (form.Password != form.ConfirmPassword)
            {
                errorMessage = "Las contraseñas no coinciden.";
                return;
            }

            //  AHORA usa el nuevo método que NO devuelve token
            await AuthService.RegisterWithVerificationAsync(form);

            //  Redirigir a página de verificación
            Nav.NavigateTo($"/verify-email?email={Uri.EscapeDataString(form.Email)}", replace: true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private string passwordRulesError = "La contraseña debe tener mayúscula, minúscula, número y símbolo.";

    private bool ValidatePassword()
    {
        var p = form.Password ?? "";

        bool hasUpper = p.Any(char.IsUpper);
        bool hasLower = p.Any(char.IsLower);
        bool hasDigit = p.Any(char.IsDigit);
        bool hasSymbol = p.Any(ch => !char.IsLetterOrDigit(ch));

        if (p.Length < 8) { passwordRulesError = "Debe tener mínimo 8 caracteres."; return false; }
        if (!hasUpper) { passwordRulesError = "Debe incluir al menos 1 letra mayúscula."; return false; }
        if (!hasLower) { passwordRulesError = "Debe incluir al menos 1 letra minúscula."; return false; }
        if (!hasDigit) { passwordRulesError = "Debe incluir al menos 1 número."; return false; }
        if (!hasSymbol) { passwordRulesError = "Debe incluir al menos 1 símbolo (ej. !@#$)."; return false; }

        return true;
    }

    private void OnPhoneChanged(object? value)
    {
        var s = value?.ToString() ?? "";
        form.PhoneNumber = new string(s.Where(char.IsDigit).ToArray());
    }
}