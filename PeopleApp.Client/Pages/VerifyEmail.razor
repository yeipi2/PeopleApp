@page "/verify-email"
@layout PeopleApp.Client.Layout.AuthLayout
@using PeopleApp.Client.Dtos
@using Radzen
@using Radzen.Blazor
@inject PeopleApp.Client.Services.Auth.AuthService AuthService
@inject NavigationManager Nav

<div class="auth-avatar" style="background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
    <RadzenIcon Icon="mark_email_read" Style="font-size:40px; color:#fff;" />
</div>

<h3 class="auth-title" style="color: #4CAF50; font-weight: 600; margin-bottom: 1rem;">Verifica tu correo</h3>
<p style="text-align: center; color: #666; margin-bottom: 2rem; font-size: 14px;">
    Hemos enviado un código de 6 caracteres a <strong>@email</strong>
</p>

<RadzenTemplateForm TItem="VerifyCodeRequestDto" Data="@model" Submit="@HandleVerify">
    <RadzenStack Gap="1.2rem">
        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
            <RadzenLabel Component="CodeInput" Style="font-weight: 500; color: #333;">
                Código de verificación
            </RadzenLabel>
            <RadzenTextBox Name="CodeInput" @bind-Value="model.Code" Placeholder="A1B2C3"
                           Style="width:100%; height: 48px; border-radius: 8px; border: 2px solid #C8E6C9; background-color: white; text-align: center; font-size: 20px; letter-spacing: 4px; text-transform: uppercase;"
                           MaxLength="6" />
            <RadzenRequiredValidator Component="CodeInput" Text="Código es requerido" />
            <RadzenLengthValidator Component="CodeInput" Min="6" Text="El código debe tener 6 caracteres" />
        </RadzenStack>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage"
                         Style="border-radius: 8px;" />
        }

        @if (!string.IsNullOrWhiteSpace(successMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Success" Text="@successMessage"
                         Style="border-radius: 8px;" />
        }

        <RadzenButton Text="Verificar" ButtonType="ButtonType.Submit"
                      Style="width:100%; height:52px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); border-radius: 8px; font-weight: 600; font-size: 16px; border: none;"
                      ButtonStyle="ButtonStyle.Success"
                      Disabled="@isBusy" />

        <div style="text-align:center; margin-top:12px;">
            <span style="color: #666;">¿No recibiste el código?</span>
            <RadzenButton Text="Reenviar" Click="@HandleResend"
                          ButtonStyle="ButtonStyle.Light"
                          Style="margin-left: 8px; color: #4CAF50; font-weight: 600;"
                          Disabled="@(isBusy || resendCooldown > 0)" />
            @if (resendCooldown > 0)
            {
                <span style="color: #999; font-size: 12px; margin-left: 8px;">(@resendCooldown s)</span>
            }
        </div>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [SupplyParameterFromQuery]
    public string? email { get; set; }

    private VerifyCodeRequestDto model = new();
    private string errorMessage = "";
    private string successMessage = "";
    private bool isBusy = false;
    private int resendCooldown = 0;
    private System.Threading.Timer? cooldownTimer;

    protected override void OnInitialized()
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            Nav.NavigateTo("/register");
            return;
        }

        model.Email = email;
    }

    private async Task HandleVerify(VerifyCodeRequestDto model)
    {
        try
        {
            isBusy = true;
            errorMessage = "";

            await AuthService.VerifyRegistrationAsync(model);
            successMessage = "¡Email verificado! Redirigiendo...";
            await Task.Delay(1500);
            Nav.NavigateTo("/me", replace: true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task HandleResend()
    {
        try
        {
            isBusy = true;
            errorMessage = "";
            successMessage = "";

            await AuthService.ResendVerificationAsync(new ResendCodeRequestDto { Email = email! });
            successMessage = "Código reenviado. Revisa tu correo.";

            // Iniciar cooldown de 60 segundos
            resendCooldown = 60;
            cooldownTimer?.Dispose();
            cooldownTimer = new System.Threading.Timer(_ =>
            {
                resendCooldown--;
                InvokeAsync(StateHasChanged);
                if (resendCooldown <= 0)
                {
                    cooldownTimer?.Dispose();
                }
            }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    public void Dispose()
    {
        cooldownTimer?.Dispose();
    }
}