@page "/all-people"
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Catálogo de Personas</h3>

<button class="btn btn-primary mb-3" @onclick="AbrirModal">
    Registrar persona
</button>
<button class="btn btn-secondary mb-3 ms-2" @onclick="AbrirPdfModal">
    Ver PDF
</button>


<!-- TABLA -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Estatura</th>
            <th>Peso</th>
            <th>Descripción</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in personas)
        {
            <tr>
                <td>@p.Nombre</td>
                <td>@p.Edad</td>
                <td>@p.Estatura</td>
                <td>@p.Peso</td>
                <td>@p.Descripcion</td>
            </tr>
        }
    </tbody>
</table>

<!-- MODAL -->
@if (mostrarModal)
{
    <div class="modal-backdrop">
        <div class="modal-content">

            <h4>Registrar persona</h4>

            <EditForm Model="personaNueva" OnValidSubmit="GuardarPersona">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-2">
                    <label>Nombre</label>
                    <InputText class="form-control" @bind-Value="personaNueva.Nombre" />
                </div>

                <div class="mb-2">
                    <label>Edad</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Edad" />
                </div>

                <div class="mb-2">
                    <label>Estatura</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Estatura" />
                </div>

                <div class="mb-2">
                    <label>Peso</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Peso" />
                </div>

                <div class="mb-3">
                    <label>Descripción</label>
                    <InputTextArea class="form-control" @bind-Value="personaNueva.Descripcion" />
                </div>

                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CerrarModal">
                    Cancelar
                </button>
            </EditForm>

        </div>
    </div>
}

@if (mostrarPdf)
{
    <div class="modal-backdrop">
        <div class="modal-content" style="width:80%; height:90%;">

            <h4>Vista previa PDF</h4>

            <iframe src="@pdfUrl" style="width:100%; height:75%; border:none;">
            </iframe>

            <div class="mt-3 d-flex justify-content-end gap-2">
                <button class="btn btn-primary" @onclick="ImprimirPdf">
                    Imprimir
                </button>

                <button class="btn btn-success" @onclick="DescargarPdf">
                    Descargar
                </button>

                <button class="btn btn-secondary" @onclick="CerrarPdfModal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
}


@code {
    private List<Persona> personas = new();
    private bool mostrarModal = false;
    private Persona personaNueva = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarPersonas();
    }

    private async Task CargarPersonas()
    {
        personas = await Http.GetFromJsonAsync<List<Persona>>("api/personas")
        ?? new List<Persona>();
    }

    private void AbrirModal()
    {
        personaNueva = new Persona();
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
    }

    private async Task GuardarPersona()
    {
        await Http.PostAsJsonAsync("api/personas", personaNueva);

        await CargarPersonas();

        mostrarModal = false;
    }

    public class Persona
    {
        public int Id { get; set; }

        [Required]
        public string Nombre { get; set; } = string.Empty;

        [Required]
        public int Edad { get; set; }

        [Required]
        public double Estatura { get; set; }

        [Required]
        public double Peso { get; set; }

        [Required]
        public string Descripcion { get; set; } = string.Empty;
    }
    bool mostrarPdf = false;
    string pdfUrl = "";

    void AbrirPdfModal()
    {
        pdfUrl = new Uri(Http.BaseAddress!, "api/personas/export-pdf").ToString();
        mostrarPdf = true;
    }



    void CerrarPdfModal()
    {
        mostrarPdf = false;
    }

    async Task DescargarPdf()
    {
        await JS.InvokeVoidAsync("downloadPdf", pdfUrl, "personas.pdf");
    }

    async Task ImprimirPdf()
    {
        await JS.InvokeVoidAsync("printPdf", pdfUrl);
    }
}