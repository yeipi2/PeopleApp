@using PeopleApp.Client.Dtos
@using Radzen
@using Radzen.Blazor
@inject PeopleApp.Client.Services.Auth.AuthService AuthService
@inject DialogService DialogService

<RadzenStack Gap="1.5rem">
    <RadzenTemplateForm TItem="SetPasswordDto" Data="@model" Submit="@HandleSubmit">
        <RadzenStack Gap="1rem">
            <RadzenAlert Severity="AlertSeverity.Info" Variant="Variant.Flat">
                <RadzenIcon Icon="info" Style="margin-right: 8px;" />
                Tu cuenta fue creada con Google. Establece una contraseña para poder también ingresar con email y contraseña.
            </RadzenAlert>

            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                <RadzenLabel Component="NewPassInput" Style="font-weight: 500;">
                    Nueva Contraseña
                </RadzenLabel>
                <RadzenPassword Name="NewPassInput" @bind-Value="model.NewPassword"
                                Placeholder="••••••••"
                                Style="width:100%; height: 48px;" />
                <RadzenRequiredValidator Component="NewPassInput" Text="Nueva contraseña es requerida" />
                <RadzenLengthValidator Component="NewPassInput" Min="8" Text="Mínimo 8 caracteres" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                <RadzenLabel Component="ConfirmPassInput" Style="font-weight: 500;">
                    Confirmar Contraseña
                </RadzenLabel>
                <RadzenPassword Name="ConfirmPassInput" @bind-Value="model.ConfirmPassword"
                                Placeholder="••••••••"
                                Style="width:100%; height: 48px;" />
                <RadzenRequiredValidator Component="ConfirmPassInput" Text="Confirmación es requerida" />
                <RadzenCompareValidator Component="ConfirmPassInput" Value="@model.NewPassword"
                                        Operator="CompareOperator.Equal" Text="Las contraseñas no coinciden" />
            </RadzenStack>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage" />
            }

            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                <RadzenButton Text="Cancelar" Click="@(() => DialogService.Close(false))"
                              ButtonStyle="ButtonStyle.Light" />
                <RadzenButton Text="Crear Contraseña" ButtonType="ButtonType.Submit"
                              ButtonStyle="ButtonStyle.Primary"
                              Disabled="@isBusy" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    private SetPasswordDto model = new();
    private string errorMessage = "";
    private bool isBusy = false;

    private async Task HandleSubmit(SetPasswordDto model)
    {
        try
        {
            isBusy = true;
            errorMessage = "";

            await AuthService.SetPasswordAsync(model);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }
}